func main() {

	m := NewMonitor()

	s1 := Str("s1")
	s2 := Str("s2")
	s3 := Str("s3")
	servers := Set(s1, s2, s3)

	s := State{
		matchIndex:     FnConstruct(servers, func(i TLA) TLA { return FnConstruct(servers, func(j TLA) TLA { return Int(0) }) }),
		log:            FnConstruct(servers, func(i TLA) TLA { return Seq() }),
		who:            Str("none"),
		state:          FnConstruct(servers, func(i TLA) TLA { return Str("Follower") }),
		actions:        Seq(),
		outbox:         FnConstruct(servers, func(i TLA) TLA { return Seq() }),
		inflight:       Seq(),
		commitIndex:    FnConstruct(servers, func(i TLA) TLA { return Int(0) }),
		currentTerm:    FnConstruct(servers, func(i TLA) TLA { return Int(1) }),
		votesResponded: FnConstruct(servers, func(i TLA) TLA { return Set() }),
		nextIndex:      FnConstruct(servers, func(i TLA) TLA { return FnConstruct(servers, func(j TLA) TLA { return Int(1) }) }),
		votesGranted:   FnConstruct(servers, func(i TLA) TLA { return Set() }),
		votedFor:       FnConstruct(servers, func(i TLA) TLA { return Str("none") }),
		inbox:          FnConstruct(servers, func(i TLA) TLA { return Seq() }),
	}

	m.CaptureState(s, Initial)

	projected := true

	// timeout
	s.state = Except(s.state.(Record), s1, Str("Candidate"))
	// s.currentTerm = Except(s.currentTerm.(Record), s1,
	// 	IntPlus(RecordIndex(s.currentTerm.(Record), s1).(Int), Int(1)))
	s.currentTerm = Except(s.currentTerm.(Record), s1, Int(2))
	s.actions = Append(s.actions.(Sequence), Seq(Str("Timeout"), s1))
	s.who = s1
	m.CaptureState(s, Timeout, s1)

	// -> outbox
	s.who = s1
	s2rv := Rec(
		Str("mtype"), Str("RequestVoteRequest"),
		Str("mterm"), Int(2),
		Str("mlastLogTerm"), Int(0),
		Str("mlastLogIndex"), Int(0),
		Str("msource"), s1,
		Str("mdest"), s2,
	)
	s.actions = Append(s.actions.(Sequence), Seq(Str("RequestVote"), s1, s2))
	s.outbox = Except(s.outbox.(Record), s1,
		Append(RecordIndex(s.outbox.(Record), s1).(Sequence), s2rv))
	m.CaptureState(s, RequestVote, s1, s2)

	// outbox ->
	if !projected {
		s.inflight = Seq(s2rv)
	}
	s.outbox = Except(s.outbox.(Record), s1, Seq())
	s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkTakeMessage"), s2rv))
	s.who = Str("Network")
	m.CaptureState(s, NetworkTakeMessage, s2rv)

	// second RV
	s3rv := Rec(
		Str("mtype"), Str("RequestVoteRequest"),
		Str("mterm"), Int(2),
		Str("mlastLogTerm"), Int(0),
		Str("mlastLogIndex"), Int(0),
		Str("msource"), s1,
		Str("mdest"), s3,
	)
	s.who = s1
	s.actions = Append(s.actions.(Sequence), Seq(Str("RequestVote"), s1, s3))
	s.outbox = Except(s.outbox.(Record), s1, Seq(s3rv))
	m.CaptureState(s, RequestVote, s1, s3)

	if !projected {
		s.inflight = Seq(s2rv, s3rv)
	}
	s.outbox = Except(s.outbox.(Record), s1, Seq())
	s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkTakeMessage"), s3rv))
	s.who = Str("Network")
	m.CaptureState(s, NetworkTakeMessage, s3rv)

	// receive rv 2
	if !projected {
		s.inbox = Except(s.inbox.(Record), s2, Seq(s2rv))
		s.inflight = Seq(s3rv)
		s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkDeliverMessage"), s2rv))
		s.who = Str("Network")
		m.CaptureState(s, NetworkDeliverMessage, s2rv)

		s.currentTerm = Except(s.currentTerm.(Record), s2, Int(2))
		s.actions = Append(s.actions.(Sequence), Seq(Str("UpdateTerm"), s2, s1, s2rv))
		s.who = s2
		// already follower and voted for none
		m.CaptureState(s, UpdateTerm, s2, s1, s2rv)
	}

	s2rvr := Rec(
		Str("mtype"), Str("RequestVoteResponse"),
		Str("mterm"), Int(2),
		Str("mvoteGranted"), Bool(true),
		Str("msource"), s2,
		Str("mdest"), s1,
	)
	if !projected {
		s.votedFor = Except(s.votedFor.(Record), s2, s1)
		s.inbox = Except(s.inbox.(Record), s2, Seq())
		s.outbox = Except(s.outbox.(Record), s2, Seq(s2rvr))
		s.who = s2
		s.actions = Append(s.actions.(Sequence), Seq(Str("HandleRequestVoteRequest"), s2, s1, s2rv))
		m.CaptureState(s, HandleRequestVoteRequest, s2, s1, s2rv)

		s.inflight = Seq(s3rv, s2rvr)
		s.outbox = Except(s.outbox.(Record), s2, Seq())
		s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkTakeMessage"), s2rvr))
		s.who = Str("Network")
		m.CaptureState(s, NetworkTakeMessage, s2rvr)

		// receive rv 3
		s.inbox = Except(s.inbox.(Record), s3, Seq(s3rv))
		s.inflight = Seq(s2rvr)
		s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkDeliverMessage"), s3rv))
		s.who = Str("Network")
		m.CaptureState(s, NetworkDeliverMessage, s3rv)

		s.currentTerm = Except(s.currentTerm.(Record), s3, Int(2))
		s.actions = Append(s.actions.(Sequence), Seq(Str("UpdateTerm"), s3, s1, s3rv))
		s.who = s3
		// already follower and voted for none
		m.CaptureState(s, UpdateTerm, s3, s1, s3rv)
	}

	s3rvr := Rec(
		Str("mtype"), Str("RequestVoteResponse"),
		Str("mterm"), Int(2),
		Str("mvoteGranted"), Bool(true),
		Str("msource"), s3,
		Str("mdest"), s1,
	)
	if !projected {
		s.votedFor = Except(s.votedFor.(Record), s3, s1)
		s.inbox = Except(s.inbox.(Record), s3, Seq())
		s.outbox = Except(s.outbox.(Record), s3, Seq(s3rvr))
		s.who = s3
		s.actions = Append(s.actions.(Sequence), Seq(Str("HandleRequestVoteRequest"), s3, s1, s3rv))
		m.CaptureState(s, HandleRequestVoteRequest, s3, s1, s3rv)

		s.inflight = Seq(s2rvr, s3rvr)
		s.outbox = Except(s.outbox.(Record), s3, Seq())
		s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkTakeMessage"), s3rvr))
		s.who = Str("Network")
		m.CaptureState(s, NetworkTakeMessage, s3rvr)
	}

	s.inbox = Except(s.inbox.(Record), s1, Seq(s2rvr))
	if !projected {
		s.inflight = Seq(s3rvr)
	}
	s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkDeliverMessage"), s2rvr))
	s.who = Str("Network")
	m.CaptureState(s, NetworkDeliverMessage, s2rvr)

	s.inbox = Except(s.inbox.(Record), s1, Seq(s2rvr, s3rvr))
	if !projected {
		s.inflight = Seq()
	}
	s.actions = Append(s.actions.(Sequence), Seq(Str("NetworkDeliverMessage"), s3rvr))
	s.who = Str("Network")
	m.CaptureState(s, NetworkDeliverMessage, s3rvr)

	// receive rvr messages
	s.inbox = Except(s.inbox.(Record), s1, Seq(s3rvr))
	s.votesResponded = Except(s.votesResponded.(Record), s1, Set(s2))
	s.votesGranted = Except(s.votesGranted.(Record), s1, Set(s2))
	s.actions = Append(s.actions.(Sequence), Seq(Str("HandleRequestVoteResponse"), s1, s2, s2rvr))
	s.who = s1
	m.CaptureState(s, HandleRequestVoteResponse, s1, s2, s2rvr)

	s.inbox = Except(s.inbox.(Record), s1, Seq())
	s.votesResponded = Except(s.votesResponded.(Record), s1, Set(s2, s3))
	s.votesGranted = Except(s.votesGranted.(Record), s1, Set(s2, s3))
	s.actions = Append(s.actions.(Sequence), Seq(Str("HandleRequestVoteResponse"), s1, s3, s3rvr))
	s.who = s1
	m.CaptureState(s, HandleRequestVoteResponse, s1, s3, s3rvr)

	// s1 becomes leader
	s.state = Except(s.state.(Record), s1, Str("Leader"))
	s.actions = Append(s.actions.(Sequence), Seq(Str("BecomeLeader"), s1))
	m.CaptureState(s, BecomeLeader, s1)

	m.CheckTrace()
	fmt.Println("ok!")
}
